<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puff Puff Paint - TurdSoup</title>
    <style>
        body {
            background-color: #EF8C56;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 60px auto;
        }

        .header {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            padding: 0 20px;
        }

        .header-button {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .note-content {
            color: #333;
            margin: 10px 0;
        }

        .media-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .media-preview img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 5px;
        }

        .note-media {
            display: grid;
            grid-gap: 10px;
            margin: 10px 0;
        }

        .note-media.single {
            grid-template-columns: 1fr;
        }

        .note-media.multiple {
            grid-template-columns: repeat(2, 1fr);
        }

        .note-media img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 5px;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            resize: vertical;
        }

        button {
            background: #EF8C56;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #D97B45;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .note-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .note-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="header-button" onclick="window.location.href='index.html'">üè°</button>
        <div id="profile-pic" class="hidden">
            <span>ü§ñ</span>
        </div>
    </div>

    <div class="container">
        <div id="compose" class="card">
            <div class="note-header">
                <img id="compose-avatar" class="avatar" src="" alt="Profile">
                <textarea id="content" placeholder="What's on your mind?" rows="3"></textarea>
            </div>
            <div id="media-preview" class="media-preview"></div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <input type="file" accept="image/*" id="image-input" style="display: none" multiple>
                <button onclick="document.getElementById('image-input').click()">üì∑</button>
                <button onclick="publishNote()">Paint</button>
            </div>
        </div>

        <div id="notes"></div>
    </div>

    <script>
        let npub = null;
        let profile = null;
        
        const RELAYS = [
            'wss://relay.damus.io',
            'wss://nos.lol',
            'wss://relay.nostrfreaks.com'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const storedProfile = JSON.parse(localStorage.getItem('profile'));
            if (storedProfile) {
                npub = storedProfile.npub;
                profile = storedProfile;
                if (profile.picture) {
                    document.getElementById('compose-avatar').src = profile.picture;
                    document.getElementById('profile-pic').innerHTML = 
                        `<img src="${profile.picture}" alt="Profile" class="avatar">`;
                }
                document.getElementById('profile-pic').classList.remove('hidden');
                fetchNotes();
            }
        });

        // Handle image uploads
        document.getElementById('image-input').addEventListener('change', async (event) => {
            const files = event.target.files;
            if (!files.length) return;

            const preview = document.getElementById('media-preview');
            
            for (let file of files) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const authEvent = {
                        kind: 27235,
                        created_at: Math.floor(Date.now() / 1000),
                        tags: [
                            ["u", "https://nostr.build/api/v2/upload/files"],
                            ["method", "POST"]
                        ],
                        content: ""
                    };

                    const signedEvent = await window.nostr.signEvent(authEvent);

                    const response = await fetch('https://nostr.build/api/v2/upload/files', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Nostr ${btoa(JSON.stringify(signedEvent))}`
                        },
                        body: formData
                    });

                    if (!response.ok) throw new Error('Upload failed');
                    
                    const data = await response.json();
                    if (!data.data?.url) throw new Error('No URL in response');

                    const img = document.createElement('img');
                    img.src = data.data.url;
                    img.dataset.url = data.data.url;
                    preview.appendChild(img);
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Failed to upload image: ' + error.message);
                }
            }
            event.target.value = '';
        });

        async function publishNote() {
            const content = document.getElementById('content').value;
            const images = Array.from(document.getElementById('media-preview').getElementsByTagName('img'))
                .map(img => img.dataset.url);
            
            if (!content.trim() && images.length === 0) {
                alert('Please add some content or images');
                return;
            }

            try {
                const event = {
                    kind: 1,
                    content: content,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ["t", "puffpuffpaint"],
                        ...images.map(url => ["r", url])
                    ]
                };

                const signedEvent = await window.nostr.signEvent(event);
                
                await Promise.all(RELAYS.map(relay => publishToRelay(relay, signedEvent)));

                document.getElementById('content').value = '';
                document.getElementById('media-preview').innerHTML = '';
                fetchNotes();
            } catch (error) {
                console.error('Publish error:', error);
                alert('Failed to publish note: ' + error.message);
            }
        }

        function publishToRelay(relay, event) {
            return new Promise((resolve) => {
                const ws = new WebSocket(relay);
                ws.onopen = () => {
                    ws.send(JSON.stringify(["EVENT", event]));
                    setTimeout(() => {
                        ws.close();
                        resolve();
                    }, 2000);
                };
                ws.onerror = () => resolve();
            });
        }

        async function fetchNotes() {
            const notesDiv = document.getElementById('notes');
            notesDiv.innerHTML = '';
            const seenNotes = new Set();

            const fetchFromRelay = (relay) => {
                return new Promise((resolve) => {
                    const ws = new WebSocket(relay);
                    ws.onopen = () => {
                        ws.send(JSON.stringify([
                            "REQ",
                            "feed",
                            {
                                kinds: [1],
                                "#t": ["puffpuffpaint"],
                                limit: 50
                            }
                        ]));
                    };

                    ws.onmessage = async (e) => {
                        const data = JSON.parse(e.data);
                        if (data[0] === "EVENT") {
                            const note = data[2];
                            if (!seenNotes.has(note.id)) {
                                seenNotes.add(note.id);
                                const noteElement = await createNoteElement(note);
                                notesDiv.appendChild(noteElement);
                            }
                        }
                    };

                    setTimeout(() => {
                        ws.close();
                        resolve();
                    }, 3000);
                });
            };

            await Promise.all(RELAYS.map(fetchFromRelay));
        }

        async function fetchProfile(pubkey) {
            return new Promise((resolve) => {
                const ws = new WebSocket('wss://relay.damus.io');
                ws.onopen = () => {
                    ws.send(JSON.stringify(["REQ", "profile", { kinds: [0], authors: [pubkey] }]));
                };
                ws.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    if (data[0] === "EVENT" && data[2].content) {
                        try {
                            const profile = JSON.parse(data[2].content);
                            ws.close();
                            resolve(profile);
                        } catch (error) {
                            resolve({});
                        }
                    }
                };
                setTimeout(() => {
                    ws.close();
                    resolve({});
                }, 3000);
            });
        }

        async function createNoteElement(note) {
            const authorProfile = await fetchProfile(note.pubkey);
            const div = document.createElement('div');
            div.className = 'card';
            
            const images = note.tags.filter(tag => tag[0] === 'r').map(tag => tag[1]);
            
            div.innerHTML = `
                <div class="note-header">
                    <img src="${authorProfile.picture || '#'}" 
                         alt="Profile" 
                         class="avatar"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'%3E%3Cpath fill=\'%23ccc\' d=\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\'/%3E%3C/svg%3E';">
                    <div>
                        <strong>${authorProfile.name || note.pubkey.slice(0, 8)}</strong>
                    </div>
                </div>
                <div class="note-content">${note.content}</div>
                ${images.length ? `
                    <div class="note-media ${images.length === 1 ? 'single' : 'multiple'}">
                        ${images.map(url => `
                            <img src="${url}" alt="Attached" loading="lazy">
                        `).join('')}
                    </div>
                ` : ''}
                <div class="note-actions">
                    <button onclick="sendZap('${note.id}', '${note.pubkey}')">‚ö°Ô∏è Zap</button>
                    <button onclick="replyToNote('${note.id}')">üí¨ Reply</button>
                </div>
            `;

            return div;
        }

        async function sendZap(noteId, pubkey) {
            if (!window.webln) {
                alert('Please install a WebLN provider like Alby!');
                return;
            }

            try {
                const authorProfile = await fetchProfile(pubkey);
                if (!authorProfile.lud16 && !authorProfile.lud06) {
                    alert('Author has not set up Lightning address');
                    return;
                }

                await window.webln.enable();
                const invoice = await fetchZapInvoice(authorProfile, noteId);
                await window.webln.sendPayment(invoice);
                alert('Zap sent! ‚ö°Ô∏è');
            } catch (error) {
                console.error('Zap error:', error);
                alert('Failed to send zap: ' + error.message);
            }
        }

        async function fetchZapInvoice(profile, noteId, amount = 1000) {
            const lnurl = profile.lud16 || profile.lud06;
            const response = await fetch(`https://api.snort.social/api/v1/lnurl/pay/${encodeURIComponent(lnurl)}`);
            if (!response.ok) throw new Error('Failed to get zap endpoint');
            
            const data = await response.json();
            if (!data.callback) throw new Error('Invalid LNURL response');

            const zapResponse = await fetch(`${data.callback}?amount=${amount}`);
            if (!zapResponse.ok) throw new Error('Failed to get invoice');
            
            const zapData = await zapResponse.json();
            return zapData.pr;
        }
    </script>
</body>
</html>
