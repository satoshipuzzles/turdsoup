<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puff Puff Paint</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js">
    <style>
        /* Custom styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            position: relative;
        }

        .comment-thread {
            margin-left: 20px;
            border-left: 2px solid #e5e7eb;
            padding-left: 20px;
        }

        .dropzone {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }

        .dropzone.dragover {
            border-color: #60a5fa;
            background: #f0f9ff;
        }

        .mention-popup {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .mention-item {
            padding: 8px 16px;
            cursor: pointer;
        }

        .mention-item:hover {
            background: #f3f4f6;
        }

        .zap-animation {
            animation: zap-pulse 0.5s ease-out;
        }

        @keyframes zap-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .hashtag {
            color: #60a5fa;
            cursor: pointer;
        }

        .reaction-count {
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold">Puff Puff Paint</h1>
                    <div class="flex items-center space-x-4">
                        <button id="connectNostr" class="px-4 py-2 bg-purple-600 text-white rounded-lg">
                            Connect with Nostr
                        </button>
                        <button id="walletSettings" class="hidden px-4 py-2 bg-yellow-500 text-white rounded-lg">
                            Connect Wallet
                        </button>
                        <div id="userProfile" class="hidden">
                            <img src="" alt="Profile" class="w-10 h-10 rounded-full cursor-pointer">
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Post Creation -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex space-x-4">
                    <img id="userAvatar" src="/default-avatar.png" alt="User" class="w-12 h-12 rounded-full">
                    <div class="flex-1">
                        <textarea id="postContent" rows="3" 
                            class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="What's on your mind?"></textarea>
                        
                        <!-- Image Upload Zone -->
                        <div id="dropzone" class="dropzone mt-4">
                            <div id="dropzoneText">
                                Drop image here or click to upload
                            </div>
                            <input type="file" id="fileInput" class="hidden" accept="image/*">
                            <img id="imagePreview" class="hidden max-h-64 mx-auto mt-4">
                        </div>

                        <div class="flex justify-between items-center mt-4">
                            <div class="flex space-x-4">
                                <button id="emojiPicker" class="text-gray-500 hover:text-gray-700">
                                    ðŸ˜Š
                                </button>
                                <button id="attachImage" class="text-gray-500 hover:text-gray-700">
                                    ðŸ“Ž
                                </button>
                            </div>
                            <button id="submitPost" class="px-4 py-2 bg-purple-600 text-white rounded-lg">
                                Post
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posts Feed -->
            <div id="feed" class="space-y-6">
                <!-- Posts will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="walletModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Connect Lightning Wallet</h2>
            <p class="mb-4">Enter your Nostr Wallet Connect (NWC) URI:</p>
            <input type="text" id="nwcUri" class="w-full border rounded-lg p-2 mb-4" 
                placeholder="nostr+walletconnect://...">
            <div class="flex justify-end space-x-4">
                <button onclick="closeWalletModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                <button onclick="connectWallet()" class="px-4 py-2 bg-purple-600 text-white rounded-lg">Connect</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let profiles = {};
        let posts = [];
        let nwcConnection = null;
        let mentionSearch = '';
        let mentionPopup = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Connect button handler
            document.getElementById('connectNostr').addEventListener('click', connectNostr);
            
            // Wallet settings handler
            document.getElementById('walletSettings').addEventListener('click', showWalletModal);
            
            // Post submission handler
            document.getElementById('submitPost').addEventListener('click', submitPost);
            
            // File drop zone handlers
            const dropzone = document.getElementById('dropzone');
            dropzone.addEventListener('dragover', handleDragOver);
            dropzone.addEventListener('dragleave', handleDragLeave);
            dropzone.addEventListener('drop', handleDrop);
            dropzone.addEventListener('click', () => document.getElementById('fileInput').click());
            
            // File input handler
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // Post content handler for mentions
            document.getElementById('postContent').addEventListener('input', handleContentInput);
            
            // Check for existing connection
            const savedPubkey = localStorage.getItem('nostr_pubkey');
            if (savedPubkey) {
                await autoConnect(savedPubkey);
            }
        });

        // Nostr connection
        async function connectNostr() {
            try {
                if (!window.nostr) {
                    throw new Error('Nostr extension not found');
                }

                const pubkey = await window.nostr.getPublicKey();
                currentUser = { pubkey };
                
                // Save connection
                localStorage.setItem('nostr_pubkey', pubkey);
                
                // Update UI
                document.getElementById('connectNostr').classList.add('hidden');
                document.getElementById('walletSettings').classList.remove('hidden');
                document.getElementById('userProfile').classList.remove('hidden');
                
                // Load user profile
                await loadUserProfile(pubkey);
                
                // Load feed
                await loadFeed();
                
                // Subscribe to new posts
                subscribeToFeed();
            } catch (error) {
                console.error('Failed to connect:', error);
                alert('Failed to connect. Please make sure you have a Nostr extension installed.');
            }
        }

        // Profile loading
        async function loadUserProfile(pubkey) {
            try {
                const profile = await fetchProfile(pubkey);
                profiles[pubkey] = profile;
                
                // Update UI
                if (profile.picture) {
                    document.getElementById('userAvatar').src = profile.picture;
                    document.getElementById('userProfile').querySelector('img').src = profile.picture;
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        // Feed loading
        async function loadFeed() {
            try {
                const relays = ['wss://relay.damus.io', 'wss://relay.nostr.band'];
                const events = await fetchEvents(relays);
                posts = events;
                renderFeed();
            } catch (error) {
                console.error('Failed to load feed:', error);
            }
        }

        // Event subscription
        function subscribeToFeed() {
            const relays = ['wss://relay.damus.io', 'wss://relay.nostr.band'];
            relays.forEach(relay => {
                const ws = new WebSocket(relay);
                
                ws.onopen = () => {
                    // Subscribe to new posts
                    const sub = ['REQ', 'feed', { kinds: [1], limit: 20 }];
                    ws.send(JSON.stringify(sub));
                };
                
                ws.onmessage = async (e) => {
                    const data = JSON.parse(e.data);
                    if (data[0] === 'EVENT') {
                        const event = data[1];
                        await handleNewPost(event);
                    }
                };
            });
        }

        // Post handling
        async function submitPost() {
            try {
                const content = document.getElementById('postContent').value;
                const imagePreview = document.getElementById('imagePreview');
                
                if (!content && imagePreview.classList.contains('hidden')) {
                    return;
                }
                
                // Prepare event
                const event = {
                    kind: 1,
                    created_at: Math.floor(Date.now() / 1000),
                    content,
                    tags: []
                };
                
                // Add image if present
                if (!imagePreview.classList.contains('hidden')) {
                    const imageUrl = await uploadImage(imagePreview.src);
                    event.tags.push(['r', imageUrl]);
                }
                
                // Add mentions
                const mentions = extractMentions(content);
                mentions.forEach(mention => {
                    event.tags.push(['p', mention]);
                });
                
                // Add hashtags
                const hashtags = extractHashtags(content);
                hashtags.forEach(tag => {
                    event.tags.push(['t', tag]);
                });
                
                // Sign and publish
                const signedEvent = await window.nostr.signEvent(event);
                await publishEvent(signedEvent);
                
                // Clear form
                document.getElementById('postContent').value = '';
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                
                // Update feed
                await loadFeed();
            } catch (error) {
                console.error('Failed to submit post:', error);
                alert('Failed to submit post. Please try again.');
            }
        }

        // Image upload with NIP-98
        async function uploadImage(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                // Create NIP-98 event
                const event = {
                    kind: 27235,
                    created_at: Math.floor(Date.now() / 1000),
                    content: "",
                    tags: [
                        ["u", "https://nostr.build/api/v2/upload/files"],
                        ["method", "POST"],
                    ],
                    pubkey: currentUser.pubkey
                };

                // Sign the event
                const signedEvent = await window.nostr.signEvent(event);
                
                // Base64 encode the signed event
                const authToken = btoa(JSON.stringify(signedEvent));

                const response = await fetch('https://nostr.build/api/v2/upload/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Nostr ${authToken}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${await response.text()}`);
                }

                const result = await response.json();
                
                if (result.status === 'success') {
                    return result.data[0].url;
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Image upload error:', error);
                throw error;
            }
        }

        // NWC Integration
        async function connectWallet() {
            try {
                const uri = document.getElementById('nwcUri').value;
                if (!uri.startsWith('nostr+walletconnect://')) {
                    throw new Error('Invalid NWC URI');
                }

                const url = new URL(uri);
                const relays = url.searchParams.getAll('relay');
                const secret = url.searchParams.get('secret');

                if (!relays.length || !secret) {
                    throw new Error('Invalid NWC URI');
                }

                // Save connection
                localStorage.setItem(`nwc-${currentUser.pubkey}`, uri);
                
                // Close modal
                closeWalletModal();
                
                // Update UI
                document.getElementById('walletSettings').textContent = 'Wallet Connected';
                document.getElementById('walletSettings').classList.add('bg-green-500');
            }
        }

        // Reaction and Zap handling
        async function handleZap(event, amount = 1000) {
            try {
                const nwcUri = localStorage.getItem(`nwc-${currentUser.pubkey}`);
                if (!nwcUri) {
                    alert('Please connect a wallet first!');
                    showWalletModal();
                    return;
                }

                const url = new URL(nwcUri);
                const relays = url.searchParams.getAll('relay');
                const secret = url.searchParams.get('secret');

                // Create invoice request
                const requestEvent = {
                    kind: 23194,
                    created_at: Math.floor(Date.now() / 1000),
                    content: JSON.stringify({
                        method: "pay_invoice",
                        params: {
                            amount: amount * 1000 // convert to msats
                        }
                    }),
                    tags: [['p', event.pubkey]],
                    pubkey: currentUser.pubkey
                };

                const signedRequest = await window.nostr.signEvent(requestEvent);
                
                // Send to relays
                const responses = await Promise.all(
                    relays.map(async relay => {
                        const ws = new WebSocket(relay);
                        return new Promise((resolve, reject) => {
                            ws.onopen = () => {
                                ws.send(JSON.stringify(['EVENT', signedRequest]));
                            };
                            ws.onmessage = (msg) => {
                                const data = JSON.parse(msg.data);
                                if (data[0] === 'OK') {
                                    resolve(true);
                                }
                            };
                            ws.onerror = reject;
                        });
                    })
                );

                // Show success animation
                const zapButton = document.querySelector(`[data-event-id="${event.id}"] .zap-button`);
                zapButton.classList.add('zap-animation');
                setTimeout(() => zapButton.classList.remove('zap-animation'), 500);

                // Update zap count
                const zapCount = document.querySelector(`[data-event-id="${event.id}"] .zap-count`);
                zapCount.textContent = parseInt(zapCount.textContent) + 1;
            } catch (error) {
                console.error('Zap failed:', error);
                alert('Failed to send zap. Please try again.');
            }
        }

        // Comment handling with nesting
        function renderComments(eventId, comments) {
            const container = document.querySelector(`[data-event-id="${eventId}"] .comments`);
            const nestedComments = buildCommentTree(comments);
            container.innerHTML = renderCommentTree(nestedComments);
        }

        function buildCommentTree(comments) {
            const commentMap = new Map();
            const roots = [];

            // First pass: create nodes
            comments.forEach(comment => {
                commentMap.set(comment.id, {
                    ...comment,
                    children: []
                });
            });

            // Second pass: build tree
            comments.forEach(comment => {
                const parentId = comment.tags.find(t => t[0] === 'e')?.[1];
                const node = commentMap.get(comment.id);

                if (parentId && commentMap.has(parentId)) {
                    commentMap.get(parentId).children.push(node);
                } else {
                    roots.push(node);
                }
            });

            return roots;
        }

        function renderCommentTree(comments, level = 0) {
            return comments
                .sort((a, b) => b.created_at - a.created_at)
                .map(comment => {
                    const profile = profiles[comment.pubkey] || {};
                    const marginLeft = level * 20;

                    return `
                        <div class="comment-thread" style="margin-left: ${marginLeft}px">
                            <div class="flex space-x-3 p-3">
                                <img src="${profile.picture || '/default-avatar.png'}" 
                                    alt="${profile.name || 'Anonymous'}"
                                    class="w-8 h-8 rounded-full">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-medium">${profile.name || 'Anonymous'}</span>
                                        <span class="text-gray-500 text-sm">
                                            ${formatDate(comment.created_at)}
                                        </span>
                                    </div>
                                    <p class="text-gray-900 mt-1">${renderContent(comment.content)}</p>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <button onclick="handleReply('${comment.id}')"
                                            class="text-gray-500 hover:text-gray-700 text-sm">
                                            Reply
                                        </button>
                                        <button onclick="handleZap(${JSON.stringify(comment)})"
                                            class="text-gray-500 hover:text-yellow-500 text-sm zap-button">
                                            âš¡ <span class="zap-count">0</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ${comment.children.length ? renderCommentTree(comment.children, level + 1) : ''}
                        </div>
                    `;
                }).join('');
        }

        // Content rendering with mentions and hashtags
        function renderContent(content) {
            // Replace mentions with links
            content = content.replace(/@(\w+)/g, (match, name) => {
                const profile = findProfileByName(name);
                if (profile) {
                    return `<a href="#" class="text-purple-600 hover:underline">@${name}</a>`;
                }
                return match;
            });

            // Replace hashtags with links
            content = content.replace(/#(\w+)/g, 
                '<a href="#" class="hashtag">#$1</a>'
            );

            // Convert markdown
            content = marked(content);

            return content;
        }

        // Mention handling
        function handleContentInput(e) {
            const textarea = e.target;
            const text = textarea.value;
            const lastWord = text.split(/\s/).pop();

            if (lastWord.startsWith('@')) {
                mentionSearch = lastWord.slice(1);
                showMentionPopup(textarea);
            } else {
                hideMentionPopup();
            }
        }

        function showMentionPopup(textarea) {
            if (!mentionPopup) {
                mentionPopup = document.createElement('div');
                mentionPopup.className = 'mention-popup';
                document.body.appendChild(mentionPopup);
            }

            const matches = findProfileMatches(mentionSearch);
            mentionPopup.innerHTML = matches
                .map(profile => `
                    <div class="mention-item" onclick="insertMention('${profile.name}')">
                        <img src="${profile.picture || '/default-avatar.png'}" 
                            class="w-6 h-6 rounded-full inline-block mr-2">
                        ${profile.name}
                    </div>
                `)
                .join('');

            const rect = textarea.getBoundingClientRect();
            mentionPopup.style.top = `${rect.bottom}px`;
            mentionPopup.style.left = `${rect.left}px`;
            mentionPopup.style.display = 'block';
        }

        function hideMentionPopup() {
            if (mentionPopup) {
                mentionPopup.style.display = 'none';
            }
        }

        // Utility functions
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) {
                return 'just now';
            } else if (diff < 3600000) {
                return `${Math.floor(diff / 60000)}m ago`;
            } else if (diff < 86400000) {
                return `${Math.floor(diff / 3600000)}h ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Initialize everything
        document.addEventListener('click', function(e) {
            // Close mention popup when clicking outside
            if (!e.target.closest('.mention-popup') && !e.target.closest('#postContent')) {
                hideMentionPopup();
            }
        });

    </script>
</body>
</html>
